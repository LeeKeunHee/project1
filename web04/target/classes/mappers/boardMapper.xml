<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Config 3.0//EN" "http://mybatis.org./dtd/mybatis-3-mapper.dtd">
<mapper namespace="boardMapper">
	<!-- 검색과 관련된 부분의 parameterType(전달값)은 SearchCriteria 클래스로 -->
	<!-- 검색과 관련되지 않은 부분은 parameterType(전달값)은 BoardVO 클래스로 -->
	
	<!-- 목록 조회 -->
	<select id="boardList" resultType="kr.co.vo.BoardVO" parameterType="kr.co.vo.SearchCriteria">
		select bno, title, content, writer, regdate, hit from (select bno, title, content, writer, regdate, hit, 
		row_number() over(order by bno DESC) as rnum from mp_board
		where 1=1 
		<include refid="search"></include>
		) mp where rnum between #{rowStart} and #{rowEnd} order by bno desc
	</select>
	
	<!-- 해당 글 한 건 조회 -->
	<select id="read" resultType="kr.co.vo.BoardVO" parameterType="int">
		select bno, title, content, writer, regdate
		from mp_board where bno = #{bno}
	</select>
		
	<!-- 글 등록 useGeneratedKeys:검색키 사용 유무, keyProperty:키로 사용할 컬럼명 -->
	<insert id="insert" parameterType="kr.co.vo.BoardVO" useGeneratedKeys="true" keyProperty="bno">
		<!-- 글 등록시 특정 컬럼을 키로 이용하여 시퀀스의 데이터를 불러오기 -->
		<!-- keyProperty : 키로 사용할 컬러명, order : 하단 SQL문보다 먼저 처리할 지 유무 -->
		<selectKey keyProperty="bno" resultType="int" order="BEFORE">
			select mp_board_seq.nextval from dual
		</selectKey>
		insert into mp_board (bno, title, content, writer) values(#{bno}, #{title}, #{content}, #{writer})
	</insert>
	
	<!-- 글 변경 -->
	<update id="update" parameterType="kr.co.vo.BoardVO">
		update mp_board set title=#{title}, content=#{content}
		where bno=#{bno}
	</update>
	<!-- 글 삭제 -->
	<delete id="delete" parameterType="int">
		delete from mp_board where bno = #{bno}
	</delete>
	
	<!-- 해당 검색 조건에 맞는 데이터의 건수 구하기 -->
	<select id="listCount" resultType="int" parameterType="kr.co.vo.SearchCriteria">
		select count(bno)
		from mp_board
		where 1=1
		<include refid="search"></include>
		and bno > 0
	</select>
	
	<!-- 나중에  태그 걸어줄것 <select id="searchType" name="searchType">
		<option value="t">제목</option>
		<option value="c">내용</option>
		<option value="w">작성자</option>
		<option value="tc">제목+내용</option>
	</select>
	<input type="text" name="keyword"> -->
	
	<!-- 조회 조건 바인딩 -->
	<sql id="search">
		<if test="searchType !=null">
			<if test="searchType =='t'.toString()">AND TITLE LIKE '%' || #{keyword} || '%'</if>
			<if test="searchType =='c'.toString()">AND content LIKE '%' || #{keyword} || '%'</if>
			<if test="searchType =='w'.toString()">AND writer LIKE '%' || #{keyword} || '%'</if>
			<if test="searchType =='tc'.toString()">AND TITLE LIKE '%' || #{keyword} || '%')or content like '%' || #{keyword} || '%'</if>
		</if>
	</sql>
	
	<!-- 파일첨부와 관련된 부분의 parameterType(전달값)은 hashMap으로 -->
	<!-- 첨부파일 추가(업로드) -->
	<insert id="insertFile" parameterType="hashMap">
		insert into mp_file(file_no, bno, org_file_name, stored_file_name, file_size)
		values(seq_mp_file_no.nextval, #{bno}, #{org_file_name}, #{stored_file_name}, #{file_size})
	</insert>
	
	<!-- 첨부파일 조회 -->
	<select id="selectFileList" resultType="hashMap" parameterType="int">
		select file_no, org_file_name, round(file_size/1024, 1) as file_size, del_gb from mp_file
		where bno=#{bno} and del_gb='N' order by file_no ASC   
	</select>
	
	<!-- 첨부파일 다운로드 -->
	<select id="selectFileInfo" resultType="hashMap" parameterType="hashMap">
		select stored_file_name, org_file_name from mp_file where file_no = #{file_no}	
	</select>
	
	<!-- 첨부파일 변경 : 파일 삭제의 유무 변경 -->
	<update id="updateFile" parameterType="hashMap">
		update mp_file set del_gb = 'Y' where file_no = #{file_no}
	</update>
	
	<!-- 게시판 조회수 증가 -->
	<update id="boardHit" parameterType="int">
		update mp_board set hit=hit+1 where bno=#{bno}
	</update>
</mapper>